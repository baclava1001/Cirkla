@inject IClient Client;
@inject NavigationManager NavigationManager;

<MudCard Elevation="2">
    <MudCarousel ItemsSource="Item?.Pictures" Style="height: 200px" ShowBullets="false" ShowArrows="_showArrows" EnableSwipeGesture="true" AutoCycle="false">
        <ItemTemplate>
            <MudCardMedia Height="200" Image="@context.Url" alt="@AltText()" />
        </ItemTemplate>
    </MudCarousel>
    <MudCardContent>
        <MudText Typo="Typo.h5" Class="text-truncate">@Item?.Name</MudText>
        <MudText Typo="Typo.body2" Class="text-truncate">@Item?.Description</MudText>
    </MudCardContent>
    <MudCardActions>
        <MudButton @onclick="NavigateToItemDetails" Variant="Variant.Text" Color="Color.Tertiary">More...</MudButton>
        <MudSpacer/>
        <MudMenuItem>
            <MudSwitch T="bool"
            Value="@_isAvailable"
            ValueChanged="@((bool val) => ToggleAvailability(val))"
            Label="Available"
            ThumbIcon="@(_isAvailable ? Icons.Material.Filled.Done : Icons.Material.Filled.Close)"
            ThumbIconColor="@(_isAvailable ? Color.Success : Color.Error)"/>
        </MudMenuItem>
        <MudMenu Icon="@Icons.Material.Filled.Settings">
            <MudMenuItem Label="Edit">
                <MudButton OnClick="() => NavigateToItemEdit()" Variant="Variant.Text" Color="Color.Default" StartIcon="@Icons.Material.Filled.Edit"/>
            </MudMenuItem>
            <MudMenuItem>
                <DeleteItemButton Item="Item"/>
            </MudMenuItem>
        </MudMenu>
    </MudCardActions>
</MudCard>

@code {

    // TODO: Add overlay over card when item is unavailable
    [Parameter]
    public Item? Item { get; set; }

    private bool _isOpen;
    private bool _isAvailable;
    private bool _showArrows;


    protected override async Task OnInitializedAsync()
    {
        _isAvailable = (Item?.Status == ItemStatus.Available);
        _showArrows = Item.Pictures.Count > 1;
    }

    // TODO: Toggling doesn't work as expected
    private async Task ToggleAvailability(bool newValue)
    {
        _isAvailable = newValue; // Ensure UI updates immediately
        Item.Status = newValue ? ItemStatus.Available : ItemStatus.Unavailable;
        try
        {
            await Client.ApiItemPutAsync(Item.Id, Item);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"API update failed: {ex.Message}");
        }
    }

    private void NavigateToItemDetails()
    {
        var url = $"/items/{Item?.Id}";
        NavigationManager.NavigateTo(url);
    }

    private void NavigateToItemEdit()
    {
        var url = $"/items/{Item?.Id}/edit";
        NavigationManager.NavigateTo(url);
    }

    private string AltText()
    {
        return $"Picture of {Item?.Name}";
    }
}